// apps/contacts/src/App-Contacts.tsx
import * as React from "react";
import { createPortal } from "react-dom";
import {
  PageHeader,
  Card,
  Table,
  TableHeader,
  TableRow,
  TableCell,
  TableFooter,
  ColumnsPopover,
  hooks,
  SearchBar,
  FilterChips,
  FiltersRow,
  IntlPhoneField,
  DetailsHost,
  DetailsScaffold,
  SectionCard,
  Button,
  Input,
  buildRangeAwareSchema,
  inDateRange,
  PillToggle,
} from "@bhq/ui";
import { getOverlayRoot, getFlyoutRoot } from "@bhq/ui/overlay";
import "@bhq/ui/styles/table.css";
import { makeApi } from "./api";

/* ────────────────────────────────────────────────────────────────────────────
 * Types & small utils
 * ────────────────────────────────────────────────────────────────────────── */

type ID = number | string;

type PhoneValue = {
  countryCode: string;
  callingCode: string;
  national: string;
  e164: string | null;
};

function getGlobalHost(id: "bhq-overlay-root" | "bhq-flyout-root") {
  if (typeof document === "undefined") return null as HTMLElement | null;
  return document.getElementById(id) as HTMLElement | null;
}

function tinyDebounce<T extends (...args: any[]) => any>(fn: T, ms = 300) {
  let t: any;
  return (...args: Parameters<T>) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), ms);
  };
}


function usePointerEventsFollowChildren(host: HTMLElement | null) {
  React.useEffect(() => {
    if (!host) return;
    const apply = () => {
      const hasKids = host.childElementCount > 0;
      host.style.pointerEvents = hasKids ? "auto" : "none";
    };
    apply();
    const mo = new MutationObserver(apply);
    mo.observe(host, { childList: true });
    return () => {
      mo.disconnect();
      host.style.pointerEvents = ""; // restore
    };
  }, [host]);
}

export type ContactRow = {
  id: ID;
  firstName?: string | null;
  lastName?: string | null;
  nickname?: string | null;
  displayName?: string | null;
  organizationId?: ID | null;
  organizationName?: string | null;
  email?: string | null;
  phone?: string | null;
  status?: string | null;
  leadStatus?: string | null;
  tags: string[];
  notes?: string | null;
  street?: string | null;
  street2?: string | null;
  city?: string | null;
  state?: string | null;
  postalCode?: string | null;
  country?: string | null;

  birthday?: string | null;
  lastContacted?: string | null;
  nextFollowUp?: string | null;

  created_at?: string | null;
  updated_at?: string | null;
  archived?: boolean | null;
};

const COLUMNS: Array<{ key: keyof ContactRow & string; label: string; default?: boolean }> = [
  { key: "firstName", label: "First", default: true },
  { key: "lastName", label: "Last", default: true },
  { key: "nickname", label: "Nickname", default: true },
  { key: "organizationName", label: "Organization", default: true },
  { key: "email", label: "Email", default: true },
  { key: "phone", label: "Phone", default: true },
  { key: "tags", label: "Tags", default: true },
  { key: "status", label: "Status", default: true },
  { key: "leadStatus", label: "Lead Status" },
  { key: "lastContacted", label: "Last Contacted" },
  { key: "nextFollowUp", label: "Next Follow-up" },
  { key: "city", label: "City" },
  { key: "state", label: "State" },
  { key: "country", label: "Country" },
  { key: "created_at", label: "Created" },
  { key: "updated_at", label: "Updated" },
];

const STORAGE_KEY = "bhq_contacts_cols_v2";
const Q_KEY = "bhq_contacts_q_v2";
const FILTERS_KEY = "bhq_contacts_filters_v2";
const DATE_KEYS = new Set([
  "birthday",
  "lastContacted",
  "nextFollowUp",
  "created_at",
  "updated_at",
] as const);

/* ────────────────────────────────────────────────────────────────────────────
 * Helpers
 * ────────────────────────────────────────────────────────────────────────── */

function fmt(d?: string | null) {
  if (!d) return "";
  const dt = new Date(d);
  if (!Number.isFinite(dt.getTime())) return String(d).slice(0, 10) || "";
  return dt.toLocaleDateString();
}

function computeDisplayName(r: any) {
  const nick = (r.nickname ?? r.displayName ?? "").trim();
  const full = [r.firstName, r.lastName].filter(Boolean).join(" ").trim();
  return nick || full || r.email || r.phone || `Contact ${r.id}`;
}

function contactToRow(p: any): ContactRow {
  const orgName =
    p.organizationName ??
    p.organization?.name ??
    p.organization?.displayName ??
    p.organization?.label ??
    null;

  return {
    id: p.id,
    firstName: p.firstName ?? p.first_name ?? null,
    lastName: p.lastName ?? p.last_name ?? null,
    nickname: p.nickname ?? null,
    displayName: p.displayName ?? p.display_name ?? null,
    organizationId: p.organizationId ?? p.organization?.id ?? null,
    organizationName: orgName,
    email: p.email ?? null,
    phone: p.phone ?? p.phoneMobileE164 ?? p.whatsappE164 ?? p.phoneE164 ?? null,
    status: p.status ?? "Active",
    leadStatus: p.leadStatus ?? null,
    tags: Array.isArray(p.tags) ? p.tags.filter(Boolean) : [],
    notes: p.notes ?? null,
    street: p.street ?? null,
    street2: p.street2 ?? null,
    city: p.city ?? null,
    state: p.state ?? null,
    postalCode: p.postalCode ?? p.zip ?? null,
    country: p.country ?? null,
    birthday: p.birthday ?? null,
    lastContacted: p.lastContacted ?? null,
    nextFollowUp: p.nextFollowUp ?? null,
    created_at: p.created_at ?? p.createdAt ?? null,
    updated_at: p.updated_at ?? p.updatedAt ?? null,
    archived: p.archived ?? null,
  };
}



/* ────────────────────────────────────────────────────────────────────────────
 * Small widgets
 * ────────────────────────────────────────────────────────────────────────── */

type OrgOption = { id: number; name: string };

const OrganizationSelect: React.FC<{
  value: OrgOption | null;
  onChange: (v: OrgOption | null) => void;
  placeholder?: string;
}> = ({ value, onChange, placeholder = "Select Organization" }) => {
  const api = React.useMemo(() => makeApi(), []);
  const [query, setQuery] = React.useState(value?.name ?? "");
  const [open, setOpen] = React.useState(false);
  const [loading, setLoading] = React.useState(false);
  const [items, setItems] = React.useState<OrgOption[]>([]);
  const [highlight, setHighlight] = React.useState<number>(-1);
  const rootRef = React.useRef<HTMLDivElement | null>(null);

  const doSearch = React.useMemo(
    () =>
      tinyDebounce(async (q: string) => {
        setLoading(true);
        try {
          const list = await api.lookups.searchOrganizations(q);
          const mapped = (list || []).map((o: any) => ({
            id: Number(o.id),
            name: String(o.name || o.displayName || o.label || ""),
          }));
          setItems(mapped);
          setHighlight(mapped.length ? 0 : -1);
        } finally {
          setLoading(false);
        }
      }, 200),
    [api]
  );

  React.useEffect(() => {
    if (open) doSearch(query);
  }, [query, open, doSearch]);

  React.useEffect(() => {
    const onDocDown = (e: MouseEvent) => {
      if (!rootRef.current) return;
      if (!rootRef.current.contains(e.target as Node)) setOpen(false);
    };
    document.addEventListener("mousedown", onDocDown);
    return () => document.removeEventListener("mousedown", onDocDown);
  }, []);

  const choose = (opt: OrgOption | null) => {
    onChange(opt);
    setQuery(opt?.name ?? "");
    setOpen(false);
  };

  return (
    <div className="relative" ref={rootRef}>
      <Input
        value={query}
        placeholder={placeholder}
        onFocus={() => setOpen(true)}
        onBlur={() => setTimeout(() => setOpen(false), 120)}
        onChange={(e) => {
          setQuery((e.currentTarget as HTMLInputElement).value);
          setOpen(true);
        }}
        onKeyDown={(e) => {
          if (!open) return;
          if (e.key === "ArrowDown") {
            e.preventDefault();
            setHighlight((h) => Math.min(h + 1, items.length - 1));
          }
          if (e.key === "ArrowUp") {
            e.preventDefault();
            setHighlight((h) => Math.max(h - 1, 0));
          }
          if (e.key === "Enter") {
            e.preventDefault();
            if (items[highlight]) choose(items[highlight]);
          }
          if (e.key === "Escape") {
            setOpen(false);
          }
        }}
      />
      {open && (
        <div
          className="absolute z-50 mt-1 w-full rounded-md border border-hairline bg-surface shadow-lg max-height-60 overflow-auto"
          role="listbox"
        >
          {loading ? (
            <div className="px-3 py-2 text-sm text-secondary">Searching…</div>
          ) : items.length === 0 ? (
            <div className="px-3 py-2 text-sm text-secondary">No organizations</div>
          ) : (
            items.map((opt, i) => (
              <button
                key={opt.id}
                type="button"
                className={`w-full text-left px-3 py-2 text-sm ${i === highlight ? "bg-white/5" : ""}`}
                onMouseEnter={() => setHighlight(i)}
                onMouseDown={(e) => e.preventDefault()}
                onClick={() => choose(opt)}
                role="option"
                aria-selected={i === highlight}
              >
                {opt.name}
              </button>
            ))
          )}
          {value && (
            <div className="border-t border-hairline">
              <button
                type="button"
                className="w-full text-left px-3 py-2 text-xs text-secondary hover:bg-white/5"
                onMouseDown={(e) => e.preventDefault()}
                onClick={() => choose(null)}
              >
                Clear selection
              </button>
            </div>
          )}
        </div>
      )}
    </div>
  );
};

const COUNTRIES = [
  "— Select country",
  "United States",
  "Argentina",
  "Australia",
  "Brazil",
  "Canada",
  "Chile",
  "China",
  "Colombia",
  "France",
  "Germany",
  "India",
  "Ireland",
  "Italy",
  "Japan",
  "Mexico",
  "Netherlands",
  "New Zealand",
  "Norway",
  "Peru",
  "Poland",
  "Portugal",
  "South Africa",
  "Spain",
  "Sweden",
  "Switzerland",
  "United Kingdom",
] as const;

const CountrySelect: React.FC<{
  value: string | null | undefined;
  onChange: (v: string | null) => void;
}> = ({ value, onChange }) => (
  <select
    className="w-full h-9 rounded-md border border-hairline bg-surface px-2 text-sm text-primary"
    value={value ?? ""}
    onChange={(e) => onChange((e.target as HTMLSelectElement).value || null)}
  >
    {COUNTRIES.map((c) => (
      <option key={c} value={c === "— Select country" ? "" : c}>
        {c}
      </option>
    ))}
  </select>
);

/* ────────────────────────────────────────────────────────────────────────────
 * Drawer view
 * ────────────────────────────────────────────────────────────────────────── */

type ContactDetailsViewProps = {
  row: ContactRow;
  mode: "view" | "edit";
  setMode: (m: "view" | "edit") => void;
  setDraft: (updater: (prev: any) => any) => void;
  activeTab: string;
  setActiveTab: (k: string) => void;
  requestSave: () => Promise<void>;
};

const ContactDetailsView: React.FC<ContactDetailsViewProps> = ({
  row,
  mode,
  setMode,
  setDraft,
  activeTab,
  setActiveTab,
  requestSave,
}) => {
  // Phone field state
  const [cell, setCell] = React.useState<PhoneValue>({
    countryCode: "US",
    callingCode: "+1",
    national: "",
    e164: (row as any).phoneMobileE164 ?? null,
  });
  const [land, setLand] = React.useState<PhoneValue>({
    countryCode: "US",
    callingCode: "+1",
    national: "",
    e164: (row as any).phoneLandlineE164 ?? null,
  });
  const [wa, setWa] = React.useState<PhoneValue>({
    countryCode: "US",
    callingCode: "+1",
    national: "",
    e164: (row as any).whatsappE164 ?? null,
  });

  // Prefs
  const [prefs, setPrefs] = React.useState(() => ({
    email: !!(row as any).prefersEmail,
    sms: !!(row as any).prefersSms,
    phone: !!(row as any).prefersPhone,
    mail: !!(row as any).prefersMail,
    whatsapp: !!(row as any).prefersWhatsapp,
  }));

  // Global hosts
  const overlayRoot = getGlobalHost("bhq-overlay-root");
const phonePortal = getFlyoutRoot();
  const FLYOUT_Z = 2147483647;

  // NEW: only clickable when populated
  usePointerEventsFollowChildren(overlayRoot);
  usePointerEventsFollowChildren(phonePortal);

  const [confirmReset, setConfirmReset] = React.useState<
    null | { channel: "email" | "sms"; onAnswer: (ok: boolean) => void }
  >(null);

  React.useEffect(() => {
    setPrefs({
      email: !!(row as any).prefersEmail,
      sms: !!(row as any).prefersSms,
      phone: !!(row as any).prefersPhone,
      mail: !!(row as any).prefersMail,
      whatsapp: !!(row as any).prefersWhatsapp,
    });
  }, [row]);

  const togglePref = React.useCallback((key: keyof typeof prefs) => {
    if (mode === "view") return;
    setPrefs((prev) => {
      const next = !prev[key];
      const camel = `prefers${key[0].toUpperCase()}${key.slice(1)}`;
      setTimeout(() => setDraft((d: any) => ({ ...d, [camel]: next })), 0);
      return { ...prev, [key]: next };
    });
  }, [mode, setDraft]);

  const editText = (k: keyof ContactRow, placeholder?: string) => (
    <Input
      size="sm"
      defaultValue={(row as any)[k] ?? ""}
      placeholder={placeholder}
      onChange={(e) =>
        setDraft((d: any) => ({
          ...d,
          [k]: (e.currentTarget as HTMLInputElement).value,
        }))
      }
    />
  );

  const titleFlair = (txt: string) => (
    <span className="text-[11px] font-semibold tracking-wide uppercase text-secondary">
      {txt}
    </span>
  );

  return (
    <DetailsScaffold
      title={computeDisplayName(row)}
      subtitle={row.organizationName || row.email || ""}
      mode={mode}
      onEdit={() => setMode("edit")}
      onCancel={() => setMode("view")}
      onSave={requestSave}
      tabs={[
        { key: "overview", label: "Overview" },
        { key: "animals", label: "Animals" },
        { key: "audit", label: "Audit" },
      ]}
      activeTab={activeTab}
      onTabChange={setActiveTab}
      rightActions={<Button size="sm" variant="outline">Archive</Button>}
    >
      {activeTab === "overview" && (
        <div className="space-y-3">
          {/* Identity */}
          <SectionCard title={titleFlair("Identity")}>
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div>
                <div className="text-xs text-secondary mb-1">First Name</div>
                {mode === "view" ? <div className="text-sm">{row.firstName || "—"}</div> : editText("firstName")}
              </div>
              <div>
                <div className="text-xs text-secondary mb-1">Last Name</div>
                {mode === "view" ? <div className="text-sm">{row.lastName || "—"}</div> : editText("lastName")}
              </div>
              <div>
                <div className="text-xs text-secondary mb-1">Nickname</div>
                {mode === "view" ? <div className="text-sm">{row.nickname || "—"}</div> : editText("nickname")}
              </div>
              <div className="sm:col-span-3">
                <div className="text-xs text-secondary mb-1">Organization</div>
                {mode === "view" ? (
                  <div className="text-sm">{row.organizationName || "—"}</div>
                ) : (
                  <OrganizationSelect
                    value={row.organizationId ? { id: Number(row.organizationId), name: row.organizationName || "" } : null}
                    onChange={(opt) =>
                      setDraft((d: any) => ({
                        ...d,
                        organizationId: opt?.id ?? null,
                        organizationName: opt?.name ?? null,
                      }))
                    }
                    placeholder="— Select Organization"
                  />
                )}
              </div>
            </div>
          </SectionCard>

          {/* Address */}
          <SectionCard title={titleFlair("Address")}>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <div className="text-xs text-secondary mb-1">Street</div>
                {mode === "view" ? <div className="text-sm">{row.street || "—"}</div> : editText("street")}
              </div>
              <div>
                <div className="text-xs text-secondary mb-1">Street 2</div>
                {mode === "view" ? <div className="text-sm">{row.street2 || "—"}</div> : editText("street2")}
              </div>
              <div>
                <div className="text-xs text-secondary mb-1">City</div>
                {mode === "view" ? <div className="text-sm">{row.city || "—"}</div> : editText("city")}
              </div>
              <div>
                <div className="text-xs text-secondary mb-1">State / Region</div>
                {mode === "view" ? <div className="text-sm">{row.state || "—"}</div> : editText("state")}
              </div>
              <div>
                <div className="text-xs text-secondary mb-1">Postal Code</div>
                {mode === "view" ? <div className="text-sm">{row.postalCode || "—"}</div> : editText("postalCode")}
              </div>
              <div>
                <div className="text-xs text-secondary mb-1">Country</div>
                {mode === "view" ? (
                  <div className="text-sm">{row.country || "—"}</div>
                ) : (
                  <CountrySelect
                    value={row.country}
                    onChange={(v) => setDraft((d: any) => ({ ...d, country: v }))}
                  />
                )}
              </div>
            </div>
          </SectionCard>

          {/* Communication Preferences */}
          <SectionCard title={titleFlair("Communication Preferences")}>
            <div className="flex flex-wrap items-center gap-2 mb-3">
              <PillToggle on={!!prefs.email} label="Email" onClick={() => togglePref("email")} className={mode === "view" ? "opacity-50 pointer-events-none" : ""} />
              <PillToggle on={!!prefs.sms} label="SMS" onClick={() => togglePref("sms")} className={mode === "view" ? "opacity-50 pointer-events-none" : ""} />
              <PillToggle on={!!prefs.phone} label="Phone" onClick={() => togglePref("phone")} className={mode === "view" ? "opacity-50 pointer-events-none" : ""} />
              <PillToggle on={!!prefs.mail} label="Mail" onClick={() => togglePref("mail")} className={mode === "view" ? "opacity-50 pointer-events-none" : ""} />
              <PillToggle on={!!prefs.whatsapp} label="WhatsApp" onClick={() => togglePref("whatsapp")} className={mode === "view" ? "opacity-50 pointer-events-none" : ""} />
            </div>

            {/* Email */}
            <div>
              <div className="text-xs text-secondary mb-1">Email</div>
              {mode === "view" ? (
                <div className="text-sm">{row.email || "—"}</div>
              ) : (
                <Input
                  size="sm"
                  type="email"
                  defaultValue={row.email ?? ""}
                  onChange={(e) => setDraft((d: any) => ({ ...d, email: (e.currentTarget as HTMLInputElement).value }))}
                />
              )}
            </div>

            {/* Phones — portal into raised flyout root */}
            <div className="sm:col-span-2">
              <div className="text-xs text-secondary mb-1">Cell Phone</div>
              {mode === "view" ? (
                <div className="text-sm">{(row as any).phoneMobileE164 || row.phone || "—"}</div>
              ) : (
                <div className="relative">
                  {/* @ts-ignore */}
                  <IntlPhoneField
                    value={cell}
                    onChange={(v) => {
                      setCell(v);
                      setDraft((d: any) => ({
                        ...d,
                        phoneMobileE164: v?.e164 ?? null,
                        phone: (v?.e164 ?? null) || (wa?.e164 ?? null),
                      }));
                    }}
                    menuPortalTarget={phonePortal}
                    menuPortalZIndex={FLYOUT_Z}
                    menuPosition="fixed"
                  />
                </div>
              )}
            </div>

            <div className="sm:col-span-2">
              <div className="text-xs text-secondary mb-1">Landline</div>
              {mode === "view" ? (
                <div className="text-sm">{(row as any).phoneLandlineE164 || "—"}</div>
              ) : (
                <div className="relative">
                  {/* @ts-ignore */}
                  <IntlPhoneField
                    value={land}
                    onChange={(v) => setLand(v)}
                    menuPortalTarget={phonePortal}
                    menuPortalZIndex={FLYOUT_Z}
                    menuPosition="fixed"
                  />
                </div>
              )}
            </div>

            <div className="sm:col-span-2">
              <div className="text-xs text-secondary mb-1">WhatsApp</div>
              {mode === "view" ? (
                <div className="text-sm">{(row as any).whatsappE164 || "—"}</div>
              ) : (
                <div className="relative">
                  {/* @ts-ignore */}
                  <IntlPhoneField
                    value={wa}
                    onChange={(v) => {
                      setWa(v);
                      setDraft((d: any) => ({
                        ...d,
                        whatsappE164: v?.e164 ?? null,
                        phone: (cell?.e164 ?? null) || (v?.e164 ?? null),
                      }));
                    }}
                    menuPortalTarget={phonePortal}
                    menuPortalZIndex={FLYOUT_Z}
                    menuPosition="fixed"
                  />
                </div>
              )}
            </div>

            {mode === "edit" && (
              <div className="text-xs text-secondary">
                If Cell Phone is left empty, WhatsApp will be used as the phone on save.
              </div>
            )}
          </SectionCard>

          {/* Compliance */}
          <SectionCard title={<span className="text-[11px] font-semibold tracking-wide uppercase text-secondary">Compliance</span>}>
            <div className="text-xs text-secondary mb-2">
              System sets these from unsubscribes. Click “Reset” to opt the user back in; action is logged on Save.
            </div>

            {mode === "view" ? (
              <div className="flex flex-wrap items-center gap-6">
                <div className="flex items-center gap-2">
                  <span className="text-xs">EMAIL</span>
                  <span className="text-xs px-2 py-0.5 rounded border border-hairline">
                    {(row as any).emailUnsubscribed ? "unsubscribed" : "subscribed"}
                  </span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-xs">SMS</span>
                  <span className="text-xs px-2 py-0.5 rounded border border-hairline">
                    {(row as any).smsUnsubscribed ? "unsubscribed" : "subscribed"}
                  </span>
                </div>
              </div>
            ) : (
              <div className="flex flex-wrap items-center gap-8">
                {/* EMAIL Reset */}
                <label className="flex items-center gap-2 text-xs">
                  <span>EMAIL</span>
                  <span className="px-2 py-0.5 rounded border border-hairline text-xs">
                    {(row as any).emailUnsubscribed ? "unsubscribed" : "subscribed"}
                  </span>
                  <input
                    type="checkbox"
                    defaultChecked={!!(row as any).emailOptOutOverride}
                    onChange={(e) => {
                      const el = e.currentTarget as HTMLInputElement;
                      const checked = el.checked;

                      if (checked) {
                        setConfirmReset({
                          channel: "email",
                          onAnswer: (ok) => {
                            if (ok) {
                              setDraft((d: any) => ({ ...d, emailOptOutOverride: true }));
                              el.checked = true;
                            } else {
                              el.checked = false;
                            }
                            setConfirmReset(null);
                          },
                        });
                      } else {
                        setDraft((d: any) => ({ ...d, emailOptOutOverride: false }));
                      }
                    }}
                  />
                  <span>Reset</span>
                </label>

                {/* SMS Reset */}
                <label className="flex items-center gap-2 text-xs">
                  <span>SMS</span>
                  <span className="px-2 py-0.5 rounded border border-hairline text-xs">
                    {(row as any).smsUnsubscribed ? "unsubscribed" : "subscribed"}
                  </span>
                  <input
                    type="checkbox"
                    defaultChecked={!!(row as any).smsOptOutOverride}
                    onChange={(e) => {
                      const el = e.currentTarget as HTMLInputElement;
                      const checked = el.checked;

                      if (checked) {
                        setConfirmReset({
                          channel: "sms",
                          onAnswer: (ok) => {
                            if (ok) {
                              setDraft((d: any) => ({ ...d, smsOptOutOverride: true }));
                              el.checked = true;
                            } else {
                              el.checked = false;
                            }
                            setConfirmReset(null);
                          },
                        });
                      } else {
                        setDraft((d: any) => ({ ...d, smsOptOutOverride: false }));
                      }
                    }}
                  />
                  <span>Reset</span>
                </label>
              </div>
            )}
          </SectionCard>
        </div>
      )}

      {activeTab === "animals" && (
        <div className="space-y-2">
          <SectionCard title={titleFlair("Associated Animals")}>
            <div className="text-sm text-secondary">Linked animals will appear here.</div>
          </SectionCard>
        </div>
      )}

      {activeTab === "audit" && (
        <div className="space-y-2">
          <SectionCard title={titleFlair("Audit")}>
            <div className="text-sm text-secondary">Events will appear here.</div>
          </SectionCard>
        </div>
      )}

      {/* Confirm Reset modal (portalled above drawer) */}
      {confirmReset && overlayRoot && createPortal(
        <div className="fixed inset-0 z-[2147483646]">
          <div
            className="absolute inset-0 bg-black/50"
            onClick={() => confirmReset.onAnswer(false)}
          />
          <div className="absolute inset-0 flex items-center justify-center">
            <div className="w-[520px] max-w-[95vw] rounded-xl border border-hairline bg-surface shadow-xl p-4">
              <div className="text-base font-semibold">
                Reset {confirmReset.channel.toUpperCase()} opt-out?
              </div>
              <div className="text-sm text-secondary mt-2">
                You are about to override the user's communication preferences and opt them back into
                receiving sales/marketing correspondence. Are you sure?
              </div>
              <div className="mt-4 flex items-center justify-end gap-2">
                <Button variant="outline" onClick={() => confirmReset.onAnswer(false)}>Cancel</Button>
                <Button onClick={() => confirmReset.onAnswer(true)}>Yes, reset</Button>
              </div>
            </div>
          </div>
        </div>,
        overlayRoot
      )}
    </DetailsScaffold>
  );
};

/* ────────────────────────────────────────────────────────────────────────────
 * Main component
 * ────────────────────────────────────────────────────────────────────────── */

export default function AppContacts() {
const phonePortal = React.useMemo(() => getFlyoutRoot(), []);

  const overlayPortal = React.useMemo(() => getOverlayRoot(), []);
  const FLYOUT_Z = 2147483647;

  // NEW: make both hosts auto-toggle pointer-events based on children globally too
  usePointerEventsFollowChildren(phonePortal);
  usePointerEventsFollowChildren(overlayPortal);

  React.useEffect(() => {
    window.dispatchEvent(
      new CustomEvent("bhq:module", { detail: { key: "contacts", label: "Contacts" } })
    );
  }, []);

  const api = React.useMemo(() => makeApi(), []);

  // Search/filters
  const [q, setQ] = React.useState(() => {
    try { return localStorage.getItem(Q_KEY) || ""; } catch { return ""; }
  });
  const [filtersOpen, setFiltersOpen] = React.useState(false);
  const [filters, setFilters] = React.useState<Record<string, string>>(() => {
    try { return JSON.parse(localStorage.getItem(FILTERS_KEY) || "{}"); } catch { return {}; }
  });
  React.useEffect(() => { try { localStorage.setItem(Q_KEY, q); } catch {} }, [q]);
  React.useEffect(() => { try { localStorage.setItem(FILTERS_KEY, JSON.stringify(filters || {})); } catch {} }, [filters]);

  const [qDebounced, setQDebounced] = React.useState(q);
  React.useEffect(() => {
    const t = setTimeout(() => setQDebounced(q.trim()), 300);
    return () => clearTimeout(t);
  }, [q]);

  // Data
  const [rows, setRows] = React.useState<ContactRow[]>([]);
  const [loading, setLoading] = React.useState<boolean>(true);
  const [error, setError] = React.useState<string | null>(null);

  // Pagination
  const [pageSize, setPageSize] = React.useState<number>(25);
  const [page, setPage] = React.useState<number>(1);

  React.useEffect(() => {
    let cancelled = false;
    (async () => {
      setLoading(true);
      setError(null);
      try {
        const res = await api.contacts.list({ q: qDebounced || undefined, page: 1, limit: 100 });
        const items = (res?.items || res?.data || []).map(contactToRow);
        if (!cancelled) setRows(items);
      } catch (e: any) {
        if (!cancelled) setError(e?.payload?.error || e?.message || "Failed to load contacts");
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => { cancelled = true; };
  }, [api, qDebounced]);

  // Columns
  const { map, toggle, setAll, visible } = hooks.useColumns(COLUMNS, STORAGE_KEY);
  const visibleSafe = Array.isArray(visible) && visible.length ? visible : COLUMNS;

  // Filters schema (range-aware)
  const filterSchemaForFiltersRow = React.useMemo(() => {
    return buildRangeAwareSchema(
      visibleSafe.map((c) => ({ key: c.key, label: c.label })),
      ["birthday", "lastContacted", "nextFollowUp", "created_at", "updated_at"]
    );
  }, [visibleSafe]);

  // Client search + filters
  const displayRows = React.useMemo(() => {
    const active = Object.entries(filters || {}).filter(([, v]) => (v ?? "") !== "");
    if (!active.length && !qDebounced) return rows;

    const lc = (v: any) => String(v ?? "").toLowerCase();
    let data = [...rows];

    if (qDebounced) {
      const ql = qDebounced.toLowerCase();
      data = data.filter((r) => {
        const hay = [
          r.nickname,
          r.firstName,
          r.lastName,
          r.displayName,
          r.organizationName,
          r.email,
          r.phone,
          ...(r.tags || []),
          r.city,
          r.state,
          r.country,
          r.status,
          r.leadStatus,
          r.birthday,
          r.lastContacted,
          r.nextFollowUp,
          r.created_at,
          r.updated_at,
        ]
          .filter(Boolean)
          .join(" ")
          .toLowerCase();
        return hay.includes(ql);
      });
    }

    if (active.length) {
      const bFrom = filters["birthday_from"];
      const bTo = filters["birthday_to"];
      const lcFrom = filters["lastContacted_from"];
      const lcTo = filters["lastContacted_to"];
      const nfFrom = filters["nextFollowUp_from"];
      const nfTo = filters["nextFollowUp_to"];
      const cFrom = filters["created_at_from"];
      const cTo = filters["created_at_to"];
      const uFrom = filters["updated_at_from"];
      const uTo = filters["updated_at_to"];

      data = data.filter((r) => {
        const textOk = active.every(([key, val]) => {
          if (key.endsWith("_from") || key.endsWith("_to")) return true;
          if (key === "tags") {
            const str = String(val).toLowerCase().trim();
            return (r.tags || []).some((t) => String(t).toLowerCase().includes(str));
          }
          const raw = (r as any)[key];
          const isDate = DATE_KEYS.has(key as any);
          const hay = isDate && raw ? String(raw).slice(0, 10) : String(raw ?? "");
          return lc(hay).includes(lc(val));
        });
        if (!textOk) return false;

        const bOk = bFrom || bTo ? inDateRange(r.birthday, bFrom, bTo) : true;
        const lcOk = lcFrom || lcTo ? inDateRange(r.lastContacted, lcFrom, lcTo) : true;
        const nfOk = nfFrom || nfTo ? inDateRange(r.nextFollowUp, nfFrom, nfTo) : true;
        const cOk = cFrom || cTo ? inDateRange(r.created_at, cFrom, cTo) : true;
        const uOk = uFrom || uTo ? inDateRange(r.updated_at, uFrom, uTo) : true;
        return bOk && lcOk && nfOk && cOk && uOk;
      });
    }

    return data;
  }, [rows, filters, qDebounced]);

  // Sorting
  const [sorts, setSorts] = React.useState<Array<{ key: string; dir: "asc" | "desc" }>>([]);
  const onToggleSort = (key: string) => {
    setSorts((prev) => {
      const found = prev.find((s) => s.key === key);
      if (!found) return [{ key, dir: "asc" }];
      if (found.dir === "asc") return prev.map((s) => (s.key === key ? { ...s, dir: "desc" } : s));
      return prev.filter((s) => s.key !== key);
    });
  };
  React.useEffect(() => { setPage(1); }, [qDebounced, filters, sorts]);

  const sortedRows = React.useMemo(() => {
    if (!sorts.length) return displayRows;
    const out = [...displayRows];
    out.sort((a, b) => {
      for (const s of sorts) {
        const av = (a as any)[s.key];
        const bv = (b as any)[s.key];
        const cmp = String(av ?? "").localeCompare(String(bv ?? ""), undefined, {
          numeric: true,
          sensitivity: "base",
        });
        if (cmp !== 0) return s.dir === "asc" ? cmp : -cmp;
      }
      return 0;
    });
    return out;
  }, [displayRows, sorts]);

  // Paging
  const pageCount = Math.max(1, Math.ceil(sortedRows.length / pageSize));
  const clampedPage = Math.min(page, pageCount);
  const start = sortedRows.length === 0 ? 0 : (clampedPage - 1) * pageSize + 1;
  const end =
    sortedRows.length === 0 ? 0 : Math.min(sortedRows.length, (clampedPage - 1) * pageSize + pageSize);
  const pageRows = React.useMemo(() => {
    const from = (clampedPage - 1) * pageSize;
    const to = from + pageSize;
    return sortedRows.slice(from, to);
  }, [sortedRows, clampedPage, pageSize]);

  /** Details config (drawer) */
  const detailsConfig = React.useMemo(
    () => ({
      idParam: "contactId",
      getRowId: (r: ContactRow) => r.id,
      width: 820,
      placement: "center" as const,
      align: "top" as const,
      fetchRow: (id: ID) => api.contacts.get(id),
      onSave: async (id: ID, draft: any) => {
        const original = rows.find((r) => String(r.id) === String(id)) as any;

        const compliancePatch: any = {};
        const complianceActions: Array<{
          channel: "email" | "sms";
          action: "override_resubscribe";
          from: "unsubscribed" | "subscribed";
          to: "subscribed";
        }> = [];

        if (draft?.emailOptOutOverride) {
          compliancePatch.emailUnsubscribed = false;
          compliancePatch.emailOptOutOverride = true;
          if (original?.emailUnsubscribed) {
            complianceActions.push({
              channel: "email",
              action: "override_resubscribe",
              from: "unsubscribed",
              to: "subscribed",
            });
          }
        }
        if (draft?.smsOptOutOverride) {
          compliancePatch.smsUnsubscribed = false;
          compliancePatch.smsOptOutOverride = true;
          if (original?.smsUnsubscribed) {
            complianceActions.push({
              channel: "sms",
              action: "override_resubscribe",
              from: "unsubscribed",
              to: "subscribed",
            });
          }
        }

        const payload = { ...draft, ...compliancePatch };
        const updated = await api.contacts.update(id, payload);

        if (complianceActions.length) {
          await api.audit.log({
            entity: "contact",
            entityId: id,
            event: "comms_override_resubscribe",
            meta: { actions: complianceActions },
          });
        }

        setRows((prev) =>
          prev.map((r) => (String(r.id) === String(id) ? { ...r, ...contactToRow(updated) } : r))
        );
      },
      header: (r: ContactRow) => ({
        title: computeDisplayName(r),
        subtitle: r.organizationName || r.email || "",
      }),
      tabs: [
        { key: "overview", label: "Overview" },
        { key: "animals", label: "Animals" },
        { key: "audit", label: "Audit" },
      ],
      customChrome: true,
      render: (props: any) => <ContactDetailsView {...props} />,
    }),
    [api, rows]
  );

  /** Create Contact modal state */
  const [createOpen, setCreateOpen] = React.useState(false);
  const [createWorking, setCreateWorking] = React.useState(false);
  const [createErr, setCreateErr] = React.useState<string | null>(null);

  // form state
  const [firstName, setFirstName] = React.useState("");
  const [lastName, setLastName] = React.useState("");
  const [nickname, setNickname] = React.useState("");
  const [email, setEmail] = React.useState("");

  // Phones (IntlPhoneField)
  const [cell, setCell] = React.useState<PhoneValue>({ countryCode: "US", callingCode: "+1", national: "", e164: null });
  const [landline, setLandline] = React.useState<PhoneValue>({ countryCode: "US", callingCode: "+1", national: "", e164: null });
  const [whatsapp, setWhatsapp] = React.useState<PhoneValue>({ countryCode: "US", callingCode: "+1", national: "", e164: null });

  // Org
  const [org, setOrg] = React.useState<{ id: number; name: string } | null>(null);

  const [status, setStatus] = React.useState<"Active" | "Inactive" | "Prospect">("Active");
  const [leadStatus, setLeadStatus] = React.useState("");
  const [birthday, setBirthday] = React.useState("");
  const [nextFollowUp, setNextFollowUp] = React.useState("");

  // Address
  const [street, setStreet] = React.useState("");
  const [street2, setStreet2] = React.useState("");
  const [city, setCity] = React.useState("");
  const [stateRegion, setStateRegion] = React.useState("");
  const [postalCode, setPostalCode] = React.useState("");
  const [country, setCountry] = React.useState("Argentina");

  // Tags/Notes
  const [tagsStr, setTagsStr] = React.useState("");
  const [notes, setNotes] = React.useState("");

  const resetCreateForm = () => {
    setFirstName(""); setLastName(""); setNickname(""); setEmail("");
    setCell({ countryCode: "US", callingCode: "+1", national: "", e164: null });
    setLandline({ countryCode: "US", callingCode: "+1", national: "", e164: null });
    setWhatsapp({ countryCode: "US", callingCode: "+1", national: "", e164: null });
    setOrg(null);
    setStatus("Active"); setLeadStatus(""); setBirthday(""); setNextFollowUp("");
    setStreet(""); setStreet2(""); setCity(""); setStateRegion(""); setPostalCode(""); setCountry("Argentina");
    setTagsStr(""); setNotes(""); setCreateErr(null);
  };

  const canCreate = firstName.trim().length > 0 && lastName.trim().length > 0;

  const doCreate = async () => {
    if (!canCreate) { setCreateErr("Please enter First and Last name."); return; }
    try {
      setCreateWorking(true);
      setCreateErr(null);

      const cellE164 = cell?.e164 || null;
      const landE164 = landline?.e164 || null;
      const waE164 = whatsapp?.e164 || null;

      const payload: any = {
        firstName: firstName.trim(),
        lastName: lastName.trim(),
        nickname: nickname.trim() || null,
        email: email.trim() || null,
        phone: cellE164 || waE164 || null,
        phoneMobileE164: cellE164,
        phoneLandlineE164: landE164,
        whatsappE164: waE164,
        status,
        leadStatus: leadStatus.trim() || null,
        birthday: birthday || null,
        nextFollowUp: nextFollowUp || null,
        organizationId: org?.id ?? null,
        street, street2, city, state: stateRegion, postalCode, country,
        tags: tagsStr.split(",").map((s) => s.trim()).filter(Boolean),
        notes: notes || null,
      };

      const created = await (api.contacts as any).create?.(payload);
      const row = contactToRow(created);
      setRows((prev) => [row, ...prev]);
      resetCreateForm();
      setCreateOpen(false);
    } catch (e: any) {
      setCreateErr(e?.message || "Failed to create contact");
    } finally {
      setCreateWorking(false);
    }
  };

  /** ─────────────────────────────────────────────────────────────────────── */

  return (
    <div className="p-4 space-y-4">
      {/* Header + actions */}
      <div className="relative">
        <PageHeader title="Contacts" subtitle="Manage your contacts and relationships" />
        <div
          className="absolute right-0 top-0 h-full flex items-center gap-2 pr-1"
          style={{ zIndex: 5, pointerEvents: "auto" }}
        >
          <Button size="sm" onClick={() => setCreateOpen(true)}>New contact</Button>
          <Button size="sm" variant="outline">...</Button>
        </div>
      </div>

      <Card>
        <div className="bhq-details-drawer">
          <DetailsHost rows={rows} config={detailsConfig}>
            <Table
              columns={COLUMNS}
              columnState={map}
              onColumnStateChange={setAll}
              getRowId={(r: ContactRow) => r.id}
              pageSize={25}
              renderStickyRight={() => (
                <ColumnsPopover
                  columns={map}
                  onToggle={toggle}
                  onSet={setAll}
                  allColumns={COLUMNS}
                  triggerClassName="bhq-columns-trigger"
                />
              )}
              stickyRightWidthPx={40}
            >
              {/* Toolbar */}
              <div className="bhq-table__toolbar px-2 pt-2 pb-3 relative z-30">
                <SearchBar
                  value={q}
                  onChange={setQ}
                  placeholder="Search any field…"
                  widthPx={520}
                  rightSlot={
                    <button
                      type="button"
                      onClick={() => setFiltersOpen((v) => !v)}
                      aria-expanded={filtersOpen}
                      title="Filters"
                      className="h-7 w-7 rounded-md flex items-center justify-center hover:bg-white/5 focus:outline-none"
                    >
                      <svg viewBox="0 0 24 24" className="h-4 w-4" fill="none" stroke="currentColor" strokeWidth="2" aria-hidden="true">
                        <path d="M3 5h18M7 12h10M10 19h4" strokeLinecap="round" />
                      </svg>
                    </button>
                  }
                />
              </div>

              {/* Filters */}
              {filtersOpen && (
                <FiltersRow
                  filters={filters}
                  onChange={(next) => setFilters(next)}
                  schema={filterSchemaForFiltersRow}
                />
              )}

              {/* Chips */}
              <FilterChips
                filters={filters}
                onChange={setFilters}
                prettyLabel={(k) => {
                  if (k === "birthday_from") return "Birthday ≥";
                  if (k === "birthday_to") return "Birthday ≤";
                  if (k === "lastContacted_from") return "Last contacted ≥";
                  if (k === "lastContacted_to") return "Last contacted ≤";
                  if (k === "nextFollowUp_from") return "Next follow-up ≥";
                  if (k === "nextFollowUp_to") return "Next follow-up ≤";
                  if (k === "created_at_from") return "Created ≥";
                  if (k === "created_at_to") return "Created ≤";
                  if (k === "updated_at_from") return "Updated ≥";
                  if (k === "updated_at_to") return "Updated ≤";
                  return k;
                }}
              />

              {/* Table */}
              <table className="min-w-max w-full text-sm">
                <TableHeader columns={visibleSafe} sorts={sorts} onToggleSort={onToggleSort} />
                <tbody>
                  {loading && (
                    <TableRow><TableCell colSpan={visibleSafe.length}>
                      <div className="py-8 text-center text-sm text-secondary">Loading contacts…</div>
                    </TableCell></TableRow>
                  )}

                  {!loading && error && (
                    <TableRow><TableCell colSpan={visibleSafe.length}>
                      <div className="py-8 text-center text-sm text-red-600">Error: {error}</div>
                    </TableCell></TableRow>
                  )}

                  {!loading && !error && pageRows.length === 0 && (
                    <TableRow><TableCell colSpan={visibleSafe.length}>
                      <div className="py-8 text-center text-sm text-secondary">No contacts to display yet.</div>
                    </TableCell></TableRow>
                  )}

                  {!loading && !error && pageRows.length > 0 &&
                    pageRows.map((r) => (
                      <TableRow key={String(r.id)} detailsRow={r}>
                        {visibleSafe.map((c) => {
                          let v = (r as any)[c.key] as any;
                          if (DATE_KEYS.has(c.key as any)) v = fmt(v);
                          if (Array.isArray(v)) v = v.join(", ");
                          return <TableCell key={c.key}>{v ?? ""}</TableCell>;
                        })}
                      </TableRow>
                    ))}
                </tbody>
              </table>

              <TableFooter
                entityLabel="contacts"
                page={clampedPage}
                pageCount={pageCount}
                pageSize={pageSize}
                pageSizeOptions={[10, 25, 50, 100]}
                onPageChange={(p) => setPage(p)}
                onPageSizeChange={(n) => { setPageSize(n); setPage(1); }}
                start={start}
                end={end}
                filteredTotal={sortedRows.length}
                total={rows.length}
              />
            </Table>
          </DetailsHost>
        </div>
      </Card>

      {/* Create Contact Modal (portalled above drawer) */}
      {createOpen && overlayPortal
        ? createPortal(
          <div role="dialog" aria-modal="true" className="fixed inset-0 z-[2147483646]">
            <div
              className="absolute inset-0 bg-black/50"
              onClick={() => !createWorking && setCreateOpen(false)}
            />
            <div className="absolute inset-0 flex items-center justify-center">
              <div className="relative z-10 w-[760px] max-w-[95vw] rounded-xl border border-hairline bg-surface shadow-xl p-4">
                <div className="flex items-center justify-between mb-2">
                  <div className="text-lg font-semibold">Create Contact</div>
                  <Button variant="ghost" onClick={() => setCreateOpen(false)}>✕</Button>
                </div>

                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  {/* Names */}
                  <div>
                    <div className="text-xs text-secondary mb-1">
                      First name <span className="text-[hsl(var(--brand-orange))]">*</span>
                    </div>
                    <Input value={firstName} onChange={(e) => setFirstName((e.currentTarget as HTMLInputElement).value)} />
                  </div>
                  <div>
                    <div className="text-xs text-secondary mb-1">
                      Last name <span className="text-[hsl(var(--brand-orange))]">*</span>
                    </div>
                    <Input value={lastName} onChange={(e) => setLastName((e.currentTarget as HTMLInputElement).value)} />
                  </div>

                  {/* Nickname */}
                  <div className="sm:col-span-2">
                    <div className="text-xs text-secondary mb-1">Preferred / Nickname</div>
                    <Input value={nickname} onChange={(e) => setNickname((e.currentTarget as HTMLInputElement).value)} />
                  </div>

                  {/* Organization */}
                  <div className="sm:col-span-2">
                    <div className="text-xs text-secondary mb-1">Organizational Association</div>
                    <OrganizationSelect value={org} onChange={setOrg} />
                  </div>

                  {/* Email */}
                  <div className="sm:col-span-2">
                    <div className="text-xs text-secondary mb-1">Email</div>
                    <Input type="email" value={email} onChange={(e) => setEmail((e.currentTarget as HTMLInputElement).value)} />
                  </div>

                  {/* Phones */}
<div className="sm:col-span-2" onMouseDownCapture={(e) => e.stopPropagation()}>
                      <div className="text-xs text-secondary mb-1">Cell Phone</div>
                    {/* @ts-ignore */}
                    <IntlPhoneField value={cell} onChange={setCell} menuPortalTarget={phonePortal} menuPortalZIndex={FLYOUT_Z} menuPosition="fixed" />
                  </div>

<div className="sm:col-span-2" onMouseDownCapture={(e) => e.stopPropagation()}>
                      <div className="text-xs text-secondary mb-1">Landline</div>
                    {/* @ts-ignore */}
                    <IntlPhoneField value={landline} onChange={setLandline} menuPortalTarget={phonePortal} menuPortalZIndex={FLYOUT_Z} menuPosition="fixed" />
                  </div>

<div className="sm:col-span-2" onMouseDownCapture={(e) => e.stopPropagation()}>
                      <div className="text-xs text-secondary mb-1">WhatsApp</div>
                    {/* @ts-ignore */}
                    <IntlPhoneField value={whatsapp} onChange={setWhatsapp} menuPortalTarget={phonePortal} menuPortalZIndex={FLYOUT_Z} menuPosition="fixed" />
                    <div className="text-xs text-secondary mt-1">
                      If Cell Phone is left empty, this will be used as the phone on save.
                    </div>
                  </div>

                  {/* Address */}
                  <div className="sm:col-span-2">
                    <div className="text-xs text-secondary mb-1">Street</div>
                    <Input value={street} onChange={(e) => setStreet((e.currentTarget as HTMLInputElement).value)} />
                  </div>
                  <div className="sm:col-span-2">
                    <div className="text-xs text-secondary mb-1">Street 2</div>
                    <Input value={street2} onChange={(e) => setStreet2((e.currentTarget as HTMLInputElement).value)} />
                  </div>

                  <div>
                    <div className="text-xs text-secondary mb-1">City</div>
                    <Input value={city} onChange={(e) => setCity((e.currentTarget as HTMLInputElement).value)} />
                  </div>
                  <div>
                    <div className="text-xs text-secondary mb-1">State / Region</div>
                    <Input value={stateRegion} onChange={(e) => setStateRegion((e.currentTarget as HTMLInputElement).value)} />
                  </div>

                  <div className="sm:col-span-2">
                    <div className="text-xs text-secondary mb-1">Zip / Postal code</div>
                    <Input value={postalCode} onChange={(e) => setPostalCode((e.currentTarget as HTMLInputElement).value)} />
                  </div>

                  <div className="sm:col-span-2">
                    <div className="text-xs text-secondary mb-1">Country</div>
                    <select
                      className="w-full h-9 rounded-md border border-hairline bg-surface px-2 text-sm text-primary"
                      value={country}
                      onChange={(e) => setCountry((e.target as HTMLSelectElement).value)}
                    >
                      {COUNTRIES.filter((c) => c !== "— Select country").map((c) => (
                        <option key={c} value={c}>{c}</option>
                      ))}
                    </select>
                  </div>

                  {/* Notes */}
                  <div className="sm:col-span-2">
                    <div className="text-xs text-secondary mb-1">Notes</div>
                    <textarea
                      className="h-24 w-full rounded-md bg-surface border border-hairline px-3 text-sm text-primary placeholder:text-secondary outline-none"
                      value={notes}
                      onChange={(e) => setNotes((e.currentTarget as HTMLTextAreaElement).value)}
                      placeholder="Context, preferences, etc."
                    />
                  </div>

                  {createErr && <div className="sm:col-span-2 text-sm text-red-600">{createErr}</div>}

                  <div className="sm:col-span-2 flex items-center justify-end gap-2 mt-2">
                    <Button
                      variant="outline"
                      onClick={() => { resetCreateForm(); setCreateOpen(false); }}
                      disabled={createWorking}
                    >
                      Cancel
                    </Button>
                    <Button onClick={doCreate} disabled={!canCreate || createWorking}>
                      {createWorking ? "Saving…" : "Save"}
                    </Button>
                  </div>
                </div>
              </div>
            </div>
          </div>,
          overlayPortal
        )
        : null}
    </div>
  );
}
