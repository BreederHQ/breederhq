// apps/organizations/src/App-Breeding.tsx
import * as React from "react";
import {
  PageHeader,
  Card,
  Table,
  TableHeader,
  TableRow,
  TableCell,
  TableFooter,
  ColumnsPopover,
  hooks,
  SearchBar,
  FilterRow,
  DetailsHost,
  DetailsScaffold,
  DetailsSpecRenderer,
  SectionCard,
  Button,
  Input,
  utils,
} from "@bhq/ui";
import { getOverlayRoot } from "@bhq/ui/overlay";
import "@bhq/ui/styles/table.css";
import { makeBreedingApi } from "./api";

type PlanRow = {
  id: number | string;
  status: string;
  code?: string | null;
  name: string;
  species: string;
  damName: string;
  sireName?: string | null;
  orgName?: string | null;

  expectedDue?: string | null;
  expectedGoHome?: string | null;

  breedDateActual?: string | null;
  birthDateActual?: string | null;
  weanedDateActual?: string | null;
  goHomeDateActual?: string | null;
  lastGoHomeDateActual?: string | null;

  lockedCycleStart?: string | null;
  lockedOvulationDate?: string | null;
  lockedDueDate?: string | null;
  lockedGoHomeDate?: string | null;

  nickname?: string | null;
  breedText?: string | null;
  depositsCommitted?: number | null;
  depositsPaid?: number | null;
  depositRisk?: number | null;

  archived?: boolean;
};

const COLUMNS: Array<{ key: keyof PlanRow & string; label: string; default?: boolean }> = [
  { key: "name", label: "Plan Name", default: true },
  { key: "nickname", label: "Nickname", default: false },
  { key: "breedText", label: "Breed", default: false },
  { key: "status", label: "Status", default: true },
  { key: "damName", label: "Dam", default: true },
  { key: "sireName", label: "Sire", default: false },
  { key: "species", label: "Species", default: false },
  { key: "orgName", label: "Organization", default: false },
  { key: "code", label: "Code", default: false },
  { key: "expectedDue", label: "Expected Due", default: true },
  { key: "expectedGoHome", label: "Expected Go Home", default: true },
  { key: "birthDateActual", label: "Whelped", default: false },
  { key: "weanedDateActual", label: "Weaned", default: false },
  { key: "breedDateActual", label: "Breeding (Actual)", default: false },
  { key: "goHomeDateActual", label: "Go Home (Actual)", default: false },
  { key: "lastGoHomeDateActual", label: "Last Go Home (Actual)", default: false },
  { key: "lockedCycleStart", label: "Cycle Start (Locked)", default: false },
  { key: "lockedOvulationDate", label: "Ovulation (Locked)", default: false },
  { key: "lockedDueDate", label: "Due (Locked)", default: false },
  { key: "lockedGoHomeDate", label: "Go Home (Locked)", default: false },
  { key: "depositsCommitted", label: "Deposits Committed", default: false },
  { key: "depositsPaid", label: "Deposits Paid", default: false },
  { key: "depositRisk", label: "Deposit Risk", default: false },
];

const STORAGE_KEY = "bhq_breeding_cols_v1";
const { readTenantIdFast, resolveTenantId } = utils;

function fmt(d?: string | null) {
  if (!d) return "";
  const dt = new Date(d);
  return Number.isFinite(dt.getTime()) ? dt.toLocaleDateString() : "";
}

function planToRow(p: BreedingPlan): PlanRow {
  return {
    id: p.id,
    status: p.status,
    code: p.code,
    name: p.name,
    species: p.species,
    damName: p.dam?.name ?? "",
    sireName: p.sire?.name ?? null,
    orgName: p.organization?.name ?? null,
    expectedDue: p.expectedDue ?? null,
    expectedGoHome: p.expectedGoHome ?? null,
    lockedCycleStart: p.lockedCycleStart ?? null,
    lockedOvulationDate: p.lockedOvulationDate ?? null,
    lockedDueDate: p.lockedDueDate ?? null,
    lockedGoHomeDate: p.lockedGoHomeDate ?? null,
    breedDateActual: p.breedDateActual ?? null,
    birthDateActual: p.birthDateActual ?? null,
    weanedDateActual: p.weanedDateActual ?? null,
    goHomeDateActual: p.goHomeDateActual ?? null,
    lastGoHomeDateActual: p.lastGoHomeDateActual ?? null,
    nickname: (p as any).nickname ?? null,
    breedText: p.breedText ?? null,
    depositsCommitted: (p as any).depositsCommittedCents ?? null,
    depositsPaid: (p as any).depositsPaidCents ?? null,
    depositRisk: (p as any).depositRiskScore ?? null,
    archived: p.archived,
  };
}

export default function AppBreeding() {
  React.useEffect(() => {
    window.dispatchEvent(new CustomEvent("bhq:module", { detail: { key: "breeding", label: "Breeding" } }));
  }, []);

  React.useEffect(() => {
    if (!getOverlayRoot()) {
      console.warn("ColumnsPopover needs an overlay root. Add <div id='bhq-overlay-root'></div> to the shell.");
    }
  }, []);

  const [q, setQ] = React.useState("");
  const [filtersOpen, setFiltersOpen] = React.useState(false);

  // dynamic filters keyed by column key
  const [filters, setFilters] = React.useState<Record<string, string | undefined>>(() => {
    try { return JSON.parse(localStorage.getItem("bhq_breeding_filters_v1") || "{}"); } catch { return {}; }
  });
  React.useEffect(() => {
    try { localStorage.setItem("bhq_breeding_filters_v1", JSON.stringify(filters || {})); } catch { }
  }, [filters]);

  // (optional) keep q across reloads as well
  React.useEffect(() => {
    try { localStorage.setItem("bhq_breeding_q_v1", q); } catch { }
  }, [q]);

  const [status, setStatus] = React.useState<string | undefined>(undefined);
  const [species, setSpecies] = React.useState<string | undefined>(undefined);

  const [qDebounced, setQDebounced] = React.useState(q);
  React.useEffect(() => {
    const t = setTimeout(() => setQDebounced(q.trim()), 300);
    return () => clearTimeout(t);
  }, [q]);

  const clearFilters = () => {
    setQ("");
    setFilters({});
  };

  // Drawer config for DetailsHost (shared across modules)
  const detailsConfig = React.useMemo(() => ({
    idParam: "orgId",
    getRowId: (r: OrgRow) => r.id,
    header: (r: OrgRow) => ({ title: r.name, subtitle: r.website || r.email || "" }),
    tabs: [
      { key: "overview", label: "Overview" },
      { key: "animals", label: "Animals" },
      { key: "audit", label: "Audit" },
    ],
    onSave: async (id: number, draft: Partial<OrgRow>) => {
      // Persist
      const updated = await api.organizations.update(id, draft);
      // Merge into local rows
      setRows(prev => prev.map(r => (r.id === id ? { ...r, ...orgToRow(updated) } : r)));
    },
    render: ({ row, mode, setMode, setDraft, activeTab }: any) => (
      <>
        {activeTab === "overview" && (
          <DrawerSection title="Profile">
            {mode === "view" ? (
              <>
                <KeyValue label="Email">{row.email || "—"}</KeyValue>
                <KeyValue label="Phone">{row.phone || "—"}</KeyValue>
                <KeyValue label="Website">{row.website || "—"}</KeyValue>
                <KeyValue label="Address">
                  {[row.street, row.street2, row.city, row.state, row.zip, row.country]
                    .filter(Boolean)
                    .join(", ") || "—"}
                </KeyValue>
                <KeyValue label="Tags">{(row.tags || []).join(", ") || "—"}</KeyValue>
                <KeyValue label="Status">{row.status || "—"}</KeyValue>
              </>
            ) : (
              <div className="grid gap-3">
                <div>
                  <div className="text-xs text-secondary mb-1">Name</div>
                  <input
                    className="w-full input"
                    defaultValue={row.name}
                    onChange={(e) => setDraft((d: any) => ({ ...d, name: e.target.value }))}
                  />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <div className="text-xs text-secondary mb-1">Email</div>
                    <input
                      className="w-full input"
                      defaultValue={row.email || ""}
                      onChange={(e) => setDraft((d: any) => ({ ...d, email: e.target.value }))}
                    />
                  </div>
                  <div>
                    <div className="text-xs text-secondary mb-1">Phone</div>
                    <input
                      className="w-full input"
                      defaultValue={row.phone || ""}
                      onChange={(e) => setDraft((d: any) => ({ ...d, phone: e.target.value }))}
                    />
                  </div>
                </div>
                <div>
                  <div className="text-xs text-secondary mb-1">Website</div>
                  <input
                    className="w-full input"
                    defaultValue={row.website || ""}
                    onChange={(e) => setDraft((d: any) => ({ ...d, website: e.target.value }))}
                  />
                </div>
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <div className="text-xs text-secondary mb-1">City</div>
                    <input
                      className="w-full input"
                      defaultValue={row.city || ""}
                      onChange={(e) => setDraft((d: any) => ({ ...d, city: e.target.value }))}
                    />
                  </div>
                  <div>
                    <div className="text-xs text-secondary mb-1">State</div>
                    <input
                      className="w-full input"
                      defaultValue={row.state || ""}
                      onChange={(e) => setDraft((d: any) => ({ ...d, state: e.target.value }))}
                    />
                  </div>
                </div>
              </div>
            )}
          </DrawerSection>
        )}

        {activeTab === "animals" && (
          <DrawerSection title="Animals">
            <div className="text-sm text-secondary">No animals yet.</div>
          </DrawerSection>
        )}

        {activeTab === "audit" && (
          <DrawerSection title="Audit">
            <div className="text-sm text-secondary">Events will appear here.</div>
          </DrawerSection>
        )}
      </>
    ),
  }), [api]);


  const [tenantId, setTenantId] = React.useState<number | null>(() => readTenantIdFast() ?? null);
  const [tenantErr, setTenantErr] = React.useState<string | null>(null);

  React.useEffect(() => {
    if (tenantId != null) return;
    let cancelled = false;
    (async () => {
      try {
        const t = await resolveTenantId();
        if (!cancelled) setTenantId(t);
      } catch (e: any) {
        if (!cancelled) setTenantErr(String(e?.message || e) || "Failed to resolve tenant");
      }
    })();
    return () => { cancelled = true; };
  }, [tenantId]);

  const api = React.useMemo(() => {
    if (tenantId == null) return null;
    return makeBreedingApi({ baseUrl: "/api/v1", tenantId, withCsrf: true });
  }, [tenantId]);

  const [rows, setRows] = React.useState<PlanRow[]>([]);
  const [loading, setLoading] = React.useState<boolean>(tenantId != null);
  const [error, setError] = React.useState<string | null>(null);

  // Pagination
  const [pageSize, setPageSize] = React.useState<number>(25);
  const [page, setPage] = React.useState<number>(1);


  React.useEffect(() => {
    if (!api) return;
    let cancelled = false;
    (async () => {
      setLoading(true);
      setError(null);
      try {
        const res = await api.listPlans({
          include: "parents,org",
          page: 1,
          limit: 50,
          q: qDebounced || undefined,
          status: status || undefined,
          species: species || undefined,
        });
        if (!cancelled) setRows(res.items.map(planToRow));
      } catch (e: any) {
        if (!cancelled) setError(e?.payload?.error || e?.message || "Failed to load plans");
      } finally {
        if (!cancelled) setLoading(false);
      }
    })();
    return () => { cancelled = true; };
  }, [api, qDebounced, status, species]);

  const { map, toggle, setAll, visible } = hooks.useColumns(COLUMNS, STORAGE_KEY);
  const visibleSafe = Array.isArray(visible) && visible.length ? visible : COLUMNS;
  // editor kinds for filters by column
  type FilterKind = "text" | "select" | "date";
  const FILTER_TYPES: Partial<Record<keyof PlanRow & string, { kind: FilterKind; options?: Array<{ label: string; value: string }> }>> = {
    status: {
      kind: "select",
      options: [
        { label: "Planning", value: "Planning" },
        { label: "Pregnant", value: "Pregnant" },
        { label: "Whelped", value: "Whelped" },
        { label: "Weaned", value: "Weaned" },
        { label: "Go Home", value: "Go Home" },
        { label: "Closed", value: "Closed" },
        { label: "Archived", value: "Archived" },
      ],
    },
    species: {
      kind: "select",
      options: [
        { label: "Dog", value: "Dog" },
        { label: "Cat", value: "Cat" },
        { label: "Horse", value: "Horse" },
      ],
    },
    expectedDue: { kind: "date" },
    expectedGoHome: { kind: "date" },
    breedDateActual: { kind: "date" },
    birthDateActual: { kind: "date" },
    weanedDateActual: { kind: "date" },
    goHomeDateActual: { kind: "date" },
    lastGoHomeDateActual: { kind: "date" },
    lockedCycleStart: { kind: "date" },
    lockedOvulationDate: { kind: "date" },
    lockedDueDate: { kind: "date" },
    lockedGoHomeDate: { kind: "date" },
  };

  // Build a schema from the currently visible columns
  const filterSchemaForFilterRow = React.useMemo(() => {
    return visibleSafe.map(col => {
      const cfg = FILTER_TYPES[col.key] || { kind: "text" as const };
      if (cfg.kind === "date") return ({ key: col.key, label: col.label, editor: "date" as const });
      if (cfg.kind === "select") return ({ key: col.key, label: col.label, editor: "select" as const });
      return ({ key: col.key, label: col.label, editor: "text" as const });
    });
  }, [visibleSafe]);


  const [sorts, setSorts] = React.useState<Array<{ key: string; dir: "asc" | "desc" }>>([]);
  const onToggleSort = (key: string) => {
    setSorts(prev => {
      const found = prev.find(s => s.key === key);
      if (!found) return [{ key, dir: "asc" }];
      if (found.dir === "asc") return prev.map(s => (s.key === key ? { ...s, dir: "desc" } : s));
      return prev.filter(s => s.key !== key);
    });
  };

  // Reset pagination when search, filters, or sorts change
  React.useEffect(() => {
    setPage(1);
  }, [qDebounced, filters, sorts]);

  const DATE_KEYS = new Set([
    "expectedDue",
    "expectedGoHome",
    "breedDateActual",
    "birthDateActual",
    "weanedDateActual",
    "goHomeDateActual",
    "lastGoHomeDateActual",
    "lockedCycleStart",
    "lockedOvulationDate",
    "lockedDueDate",
    "lockedGoHomeDate",
  ] as const);

  const displayRows = React.useMemo(() => {
    const active = Object.entries(filters || {}).filter(([, v]) => (v ?? "") !== "");
    if (!active.length && !qDebounced) return rows;

    const lc = (v: any) => String(v ?? "").toLowerCase();

    let data = [...rows];

    // Your server already uses q, but keep client-side safety
    if (qDebounced) {
      const ql = qDebounced.toLowerCase();
      data = data.filter(r => {
        const hay = [
          r.name, r.nickname, r.breedText, r.status, r.damName, r.sireName, r.species, r.orgName, r.code,
          r.expectedDue, r.expectedGoHome, r.birthDateActual, r.weanedDateActual, r.breedDateActual, r.goHomeDateActual, r.lastGoHomeDateActual,
          r.lockedCycleStart, r.lockedOvulationDate, r.lockedDueDate, r.lockedGoHomeDate,
        ].filter(Boolean).join(" ").toLowerCase();
        return hay.includes(ql);
      });
    }

    if (active.length) {
      data = data.filter(r => {
        return active.every(([key, val]) => {
          const raw = (r as any)[key];
          const isDate = DATE_KEYS.has(key as any);
          const hay = isDate && raw ? String(raw).slice(0, 10) : String(raw ?? "");
          return lc(hay).includes(lc(val));
        });
      });
    }

    return data;
  }, [rows, filters, qDebounced]);

  // Sort client-side
  const sortedRows = React.useMemo(() => {
    if (!sorts.length) return displayRows;
    const out = [...displayRows];
    out.sort((a, b) => {
      for (const s of sorts) {
        const av = (a as any)[s.key];
        const bv = (b as any)[s.key];
        const cmp = String(av ?? "").localeCompare(String(bv ?? ""), undefined, { numeric: true, sensitivity: "base" });
        if (cmp !== 0) return s.dir === "asc" ? cmp : -cmp;
      }
      return 0;
    });
    return out;
  }, [displayRows, sorts]);

  // Paging math
  const pageCount = Math.max(1, Math.ceil(sortedRows.length / pageSize));
  const clampedPage = Math.min(page, pageCount);
  const start = sortedRows.length === 0 ? 0 : (clampedPage - 1) * pageSize + 1;
  const end = sortedRows.length === 0 ? 0 : Math.min(sortedRows.length, start - 1 + pageSize);

  const pageRows = React.useMemo(() => {
    const from = (clampedPage - 1) * pageSize;
    const to = from + pageSize;
    return sortedRows.slice(from, to);
  }, [sortedRows, clampedPage, pageSize]);

  return (
    <div className="p-4 space-y-4">
      <PageHeader
        title="Breeding"
        subtitle="Create and Manage Breeding Plans for Your Animals"
        rightSlot={
          <button
            type="button"
            className="px-3 h-8 rounded-md bg-white/5 hover:bg-white/10 text-sm"
            onClick={clearFilters}
          >
            Clear filters
          </button>
        }
      />

      {tenantId == null && !tenantErr && (
        <Card><div className="p-3 text-sm text-secondary">Resolving tenant…</div></Card>
      )}
      {tenantErr && (
        <Card><div className="p-3 text-sm text-red-600">Tenant error: {tenantErr}</div></Card>
      )}

      <Card>
        <Table
          columns={COLUMNS}
          columnState={map}
          onColumnStateChange={setAll}
          getRowId={(r: PlanRow) => r.id}
          pageSize={25}
          renderStickyRight={() => (
            <ColumnsPopover
              columns={map}
              onToggle={toggle}
              onSet={setAll}
              allColumns={COLUMNS}
              triggerClassName="bhq-columns-trigger"
            />
          )}
          stickyRightWidthPx={40}
        >
          {/* Toolbar */}
          <div className="bhq-table__toolbar px-2 pt-2 pb-3 relative z-30">
            <SearchBar
              value={q}
              onChange={setQ}
              placeholder="Search any field…"
              widthPx={520}
              rightSlot={
                <button
                  type="button"
                  onClick={() => setFiltersOpen(v => !v)}
                  aria-expanded={filtersOpen}
                  title="Filters"
                  className="h-7 w-7 rounded-md flex items-center justify-center hover:bg-white/5 focus:outline-none"
                >
                  <svg viewBox="0 0 24 24" className="h-4 w-4" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M3 5h18M7 12h10M10 19h4" strokeLinecap="round" />
                  </svg>
                </button>
              }
            />
          </div>
          {/* Filters */}
          {filtersOpen && (
            <FilterRow
              filters={filters as Record<string, string>}
              onChange={(next) => setFilters(next)}
              schema={filterSchemaForFilterRow}
            // you can pass custom editors via registry if desired; the defaults already look fine
            />
          )}

          {/* Table */}
          <table className="min-w-max w-full text-sm">
            <TableHeader
              columns={visibleSafe}
              sorts={sorts}
              onToggleSort={onToggleSort}
            />
            <tbody>
              {loading && (
                <TableRow>
                  <TableCell colSpan={visibleSafe.length}>
                    <div className="py-8 text-center text-sm text-secondary">Loading plans…</div>
                  </TableCell>
                </TableRow>
              )}

              {!loading && error && (
                <TableRow>
                  <TableCell colSpan={visibleSafe.length}>
                    <div className="py-8 text-center text-sm text-red-600">Error: {error}</div>
                  </TableCell>
                </TableRow>
              )}

              {!loading && !error && pageRows.length === 0 && (
                <TableRow>
                  <TableCell colSpan={visibleSafe.length}>
                    <div className="py-8 text-center text-sm text-secondary">No breeding plans to display yet.</div>
                  </TableCell>
                </TableRow>
              )}

              {!loading && !error && pageRows.length > 0 &&
                pageRows.map(r => (
                  <TableRow key={r.id}>
                    {visibleSafe.map(c => {
                      let v = (r as any)[c.key] as any;
                      if (DATE_KEYS.has(c.key as any)) v = fmt(v);
                      return <TableCell key={c.key}>{v ?? ""}</TableCell>;
                    })}
                  </TableRow>
                ))}
            </tbody>
          </table>
          <TableFooter
            entityLabel="plans"
            page={clampedPage}
            pageCount={pageCount}
            pageSize={pageSize}
            pageSizeOptions={[10, 25, 50, 100]}
            onPageChange={(p) => setPage(p)}
            onPageSizeChange={(n) => { setPageSize(n); setPage(1); }}

            start={start}
            end={end}
            filteredTotal={sortedRows.length}
            total={rows.length}
          />

        </Table>
      </Card>
    </div>
  );
}
